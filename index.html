<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RGL Infra Performance Analyzer</title>
    <link rel="stylesheet" href="/static/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>RGL Infra Performance</h1>
            <p class="subtitle">Email Infrastructure Analysis Dashboard</p>
        </header>

        <!-- Loading State -->
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>Loading data...</p>
        </div>

        <!-- HTML VERSION: 2026-02-19-v4 - Fixed trend charts with separate line charts -->
        <!-- Main Tab Navigation -->
        <div id="mainTabNav" class="main-tab-nav" style="display: none;">
            <button class="main-tab-btn active" data-main-tab="infra">Infra</button>
            <button class="main-tab-btn" data-main-tab="clients">Clients</button>
            <button class="main-tab-btn" data-main-tab="bounces">Bounces</button>
            <button class="main-tab-btn" data-main-tab="domains">Domains</button>
        </div>

        <!-- Date Picker (only for Infra and Clients tabs) -->
        <div id="datePicker" class="period-selector" style="display: none;">
            <div class="quick-select">
                <button class="period-btn" data-period="1d">1D</button>
                <button class="period-btn" data-period="3d">3D</button>
                <button class="period-btn" data-period="7d">7D</button>
                <button class="period-btn active" data-period="14d">14D</button>
                <button class="period-btn disabled" data-period="30d" title="Coming Soon - collecting data">30D</button>
            </div>
            <div class="date-picker">
                <label>From:</label>
                <input type="date" id="startDate" />
                <label>To:</label>
                <input type="date" id="endDate" />
                <button class="apply-btn" id="applyDateRange">Apply</button>
            </div>
            <button class="refresh-btn" id="refreshBtn">↻ Refresh</button>
            <span class="date-range" id="dateRangeDisplay"></span>
            <span class="data-source" id="dataSourceLabel">Live Data</span>
        </div>

        <!-- ========================================== -->
        <!-- MAIN TAB: INFRA -->
        <!-- ========================================== -->
        <div id="main-tab-infra" class="main-tab-content" style="display: none;">
            <!-- Infra Subtabs -->
            <div class="subtab-nav">
                <button class="subtab-btn active" data-subtab="infra-overview">Overview</button>
                <button class="subtab-btn" data-subtab="infra-comparison">Comparison</button>
                <button class="subtab-btn" data-subtab="infra-clients">By Client</button>
                <button class="subtab-btn" data-subtab="infra-warmup">Warmup</button>
                <button class="subtab-btn" data-subtab="infra-cost">Cost Projections</button>
            </div>

            <!-- SUBTAB: Infra Overview -->
            <div id="subtab-infra-overview" class="subtab-content">
                <div class="overview-cards">
                    <div class="card">
                        <div class="card-label">Total Sends</div>
                        <div class="card-value" id="totalSends">-</div>
                    </div>
                    <div class="card">
                        <div class="card-label">Total Replies</div>
                        <div class="card-value" id="totalReplies">-</div>
                    </div>
                    <div class="card highlight">
                        <div class="card-label">Positive Replies</div>
                        <div class="card-value" id="totalPositive">-</div>
                    </div>
                    <div class="card">
                        <div class="card-label">Reply Rate</div>
                        <div class="card-value" id="replyRate">-</div>
                    </div>
                    <div class="card">
                        <div class="card-label">+ve Rate (Overall)</div>
                        <div class="card-value" id="positiveRate">-</div>
                    </div>
                    <div class="card">
                        <div class="card-label">+ve Rate (of Replies)</div>
                        <div class="card-value" id="positiveReplyRate">-</div>
                    </div>
                    <div class="card">
                        <div class="card-label">Mailboxes</div>
                        <div class="card-value" id="mailboxCount">-</div>
                    </div>
                </div>

                <div class="capacity-cards">
                    <div class="card-wide">
                        <div class="card-label">Current Daily Capacity</div>
                        <div class="card-value" id="currentCapacity">-</div>
                        <div class="card-sublabel">Based on current daily limits</div>
                    </div>
                    <div class="card-wide">
                        <div class="card-label">Theoretical Max Capacity</div>
                        <div class="card-value" id="theoreticalMax">-</div>
                        <div class="card-sublabel">If all mailboxes at max limit</div>
                    </div>
                    <div class="card-wide">
                        <div class="card-label">Positives/Day</div>
                        <div class="card-value" id="positivesPerDay">-</div>
                    </div>
                </div>

                <!-- Infra Performance Charts -->
                <div class="charts-section">
                    <h3>Performance by Infrastructure</h3>
                    <div class="charts-grid">
                        <div class="chart-container">
                            <h4>Sends by Infra Type</h4>
                            <canvas id="infraSendsChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <h4>Positive Rate by Infra Type</h4>
                            <canvas id="infraPositiveRateChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Performance Trends (Weekly, 6-week rolling) -->
                <div class="charts-section">
                    <h3>Performance Trends (Last 6 Weeks)</h3>
                    <div class="charts-grid">
                        <div class="chart-container">
                            <h4>Reply Rate</h4>
                            <canvas id="dailyReplyRateChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <h4>Positive Rate</h4>
                            <canvas id="dailyPositiveRateChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SUBTAB: Infra Comparison -->
            <div id="subtab-infra-comparison" class="subtab-content" style="display: none;">
                <h2>Infrastructure Performance Comparison</h2>
                <div class="table-wrapper">
                    <table id="infraTable">
                        <thead>
                            <tr>
                                <th>Infra Type</th>
                                <th>Mailboxes</th>
                                <th>Domains</th>
                                <th>Current Cap</th>
                                <th>Theo Max</th>
                                <th>Sends</th>
                                <th>Replies</th>
                                <th>Interested</th>
                                <th>Reply %</th>
                                <th>+ve %</th>
                                <th>+ve Reply %</th>
                                <th>Bounce %</th>
                                <th>Avg/MB/Day</th>
                                <th>+ve/Day</th>
                            </tr>
                        </thead>
                        <tbody id="infraTableBody">
                        </tbody>
                    </table>
                </div>

                <!-- Performance Trends by Infra Type -->
                <div class="charts-section">
                    <h3>Performance Trends by Infrastructure</h3>
                    <div class="chart-container" style="height: 350px;">
                        <canvas id="infraComparisonTrendChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- SUBTAB: Infra by Client (moved from Clients tab) -->
            <div id="subtab-infra-clients" class="subtab-content" style="display: none;">
                <h2>Client / Infra Breakdown</h2>
                <div class="filter-row">
                    <label for="clientFilter">Select Client:</label>
                    <select id="clientFilter">
                        <option value="all">All Clients</option>
                    </select>
                </div>
                <div class="table-wrapper">
                    <table id="clientInfraBreakdownTable">
                        <thead>
                            <tr>
                                <th>Client</th>
                                <th>Infra Type</th>
                                <th>Mailboxes</th>
                                <th>Domains</th>
                                <th>Sends</th>
                                <th>Replies</th>
                                <th>Interested</th>
                                <th>Reply %</th>
                                <th>+ve %</th>
                                <th>+ve Reply %</th>
                                <th>Bounce %</th>
                            </tr>
                        </thead>
                        <tbody id="clientInfraBreakdownTableBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- SUBTAB: Warmup Status -->
            <div id="subtab-infra-warmup" class="subtab-content" style="display: none;">
                <h2>Warmup Status by Infra Type</h2>
                <div class="table-wrapper">
                    <table id="warmupTable">
                        <thead>
                            <tr>
                                <th>Infra Type</th>
                                <th>Total Mailboxes</th>
                                <th>In Warmup</th>
                            </tr>
                        </thead>
                        <tbody id="warmupTableBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- SUBTAB: Cost Projections -->
            <div id="subtab-infra-cost" class="subtab-content" style="display: none;">
                <h2>Cost Projections for 100K Sends/Day</h2>
                <p class="section-desc">Estimated costs to reach 100,000 email sends per day capacity (Maldoso, Google Reseller, Aged Outlook only)</p>
                <div class="table-wrapper">
                    <table id="projectionsTable">
                        <thead>
                            <tr>
                                <th>Infra Type</th>
                                <th>Sends/MB/Day</th>
                                <th>Mailboxes Needed</th>
                                <th>Domains Needed</th>
                                <th>Monthly Cost</th>
                                <th>One-Time Setup</th>
                                <th>+ve Rate</th>
                                <th>Expected +ve/Month</th>
                                <th>Cost per Positive</th>
                            </tr>
                        </thead>
                        <tbody id="projectionsTableBody">
                        </tbody>
                    </table>
                </div>

                <div class="projections-notes">
                    <h3>Cost Breakdown</h3>
                    <ul>
                        <li><strong>Maldoso:</strong> $1.67/mailbox/month, 15 sends/day, 4 mailboxes/domain, $4 domain cost</li>
                        <li><strong>Google Reseller:</strong> $2.00/mailbox/month, 20 sends/day, 3 mailboxes/domain, $0.20 setup/mailbox, $4 domain cost</li>
                        <li><strong>Aged Outlook:</strong> $4.22/month per tenant (25 mailboxes), 10 sends/day, 1 domain/tenant, $11.22 tenant cost (one-time), $7 aged domain premium (one-time)</li>
                    </ul>
                    <h3>How Cost per Positive is Calculated</h3>
                    <p>Cost per Positive = Monthly Cost ÷ Expected Positives per Month (excludes one-time setup costs)</p>
                    <p>Expected Positives = (100K sends/day × current +ve rate) × 30 days</p>
                </div>
            </div>
        </div>

        <!-- ========================================== -->
        <!-- MAIN TAB: CLIENTS -->
        <!-- ========================================== -->
        <div id="main-tab-clients" class="main-tab-content" style="display: none;">
            <!-- Client Date Picker (independent from Infra) -->
            <div id="clientDatePicker" class="period-selector">
                <div class="quick-select">
                    <button class="client-period-btn" data-period="1d">1D</button>
                    <button class="client-period-btn" data-period="3d">3D</button>
                    <button class="client-period-btn" data-period="7d">7D</button>
                    <button class="client-period-btn active" data-period="14d">14D</button>
                    <button class="client-period-btn" data-period="30d">30D</button>
                </div>
                <div class="date-picker">
                    <label>From:</label>
                    <input type="date" id="clientStartDate" />
                    <label>To:</label>
                    <input type="date" id="clientEndDate" />
                    <button class="apply-btn" id="applyClientDateRange">Apply</button>
                </div>
                <span class="date-range" id="clientDateRangeDisplay"></span>
            </div>

            <!-- Clients Subtabs -->
            <div class="subtab-nav">
                <button class="subtab-btn active" data-subtab="clients-overview">All Clients</button>
                <button class="subtab-btn" data-subtab="clients-analytics">Client Analytics</button>
            </div>

            <!-- SUBTAB: All Clients Overview Table -->
            <div id="subtab-clients-overview" class="subtab-content">
                <h2>All Clients Performance</h2>
                <div class="table-wrapper">
                    <table id="allClientsTable">
                        <thead>
                            <tr>
                                <th>Client</th>
                                <th>Mailboxes</th>
                                <th>Domains</th>
                                <th>Sends</th>
                                <th>Replies</th>
                                <th>Interested</th>
                                <th>Reply %</th>
                                <th>+ve %</th>
                                <th>+ve Reply %</th>
                                <th>Bounce %</th>
                                <th>+ve/Day</th>
                            </tr>
                        </thead>
                        <tbody id="allClientsTableBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- SUBTAB: Client Analytics (with selector) -->
            <div id="subtab-clients-analytics" class="subtab-content" style="display: none;">
                <!-- Client Selector -->
                <div class="client-selector">
                    <label for="clientSelector">Select Client:</label>
                    <select id="clientSelector">
                        <option value="">-- Select a Client --</option>
                    </select>
                </div>

                <!-- Client Overview (shown when client selected) -->
                <div id="clientOverviewSection" style="display: none;">
                    <h2 id="selectedClientName">Client Overview</h2>

                    <!-- Client Summary Cards (same format as Infra Overview) -->
                    <div class="overview-cards">
                        <div class="card">
                            <div class="card-label">Total Sends</div>
                            <div class="card-value" id="clientTotalSends">-</div>
                        </div>
                        <div class="card">
                            <div class="card-label">Total Replies</div>
                            <div class="card-value" id="clientTotalReplies">-</div>
                        </div>
                        <div class="card highlight">
                            <div class="card-label">Positive Replies</div>
                            <div class="card-value" id="clientTotalPositive">-</div>
                        </div>
                        <div class="card">
                            <div class="card-label">Reply Rate</div>
                            <div class="card-value" id="clientReplyRate">-</div>
                        </div>
                        <div class="card">
                            <div class="card-label">+ve Rate (Overall)</div>
                            <div class="card-value" id="clientPositiveRate">-</div>
                        </div>
                        <div class="card">
                            <div class="card-label">+ve/Day</div>
                            <div class="card-value" id="clientPositivesPerDay">-</div>
                        </div>
                        <div class="card">
                            <div class="card-label">Mailboxes</div>
                            <div class="card-value" id="clientMailboxCount">-</div>
                        </div>
                    </div>

                    <!-- Client Performance Charts -->
                    <div class="charts-section">
                        <h3>Performance by Infrastructure</h3>
                        <div class="charts-grid">
                            <div class="chart-container">
                                <h4>Sends by Infra Type</h4>
                                <canvas id="clientInfraSendsChart"></canvas>
                            </div>
                            <div class="chart-container">
                                <h4>Positive Rate by Infra Type</h4>
                                <canvas id="clientInfraPositiveRateChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Client Performance Trends (Weekly, 6-week rolling) -->
                    <div class="charts-section">
                        <h3>Performance Trends (Last 6 Weeks)</h3>
                        <div class="charts-grid">
                            <div class="chart-container">
                                <h4>Reply Rate</h4>
                                <canvas id="clientDailyReplyRateChart"></canvas>
                            </div>
                            <div class="chart-container">
                                <h4>Positive Rate</h4>
                                <canvas id="clientDailyPositiveRateChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Client Infra Breakdown Table -->
                    <div class="table-section">
                        <h3>Infrastructure Breakdown</h3>
                        <div class="table-wrapper">
                            <table id="clientInfraTable">
                                <thead>
                                    <tr>
                                        <th>Infra Type</th>
                                        <th>Mailboxes</th>
                                        <th>Domains</th>
                                        <th>Sends</th>
                                        <th>Replies</th>
                                        <th>Interested</th>
                                        <th>Reply %</th>
                                        <th>+ve %</th>
                                        <th>Bounce %</th>
                                    </tr>
                                </thead>
                                <tbody id="clientInfraTableBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- No Client Selected Message -->
                <div id="noClientSelected" class="placeholder-message">
                    <p>Select a client from the dropdown above to view their performance analytics.</p>
                </div>
            </div>
        </div>

        <!-- ========================================== -->
        <!-- MAIN TAB: BOUNCES -->
        <!-- ========================================== -->
        <div id="main-tab-bounces" class="main-tab-content" style="display: none;">
            <h2>Bounce Analysis</h2>

            <!-- Independent Bounce Date Picker -->
            <div class="bounce-date-controls">
                <label>Date Range:</label>
                <input type="date" id="bounceStartDate" />
                <span>to</span>
                <input type="date" id="bounceEndDate" />
                <button id="applyBounceDate" class="btn-small">Apply</button>
                <span class="bounce-date-note">Data available from Feb 18, 2026</span>
            </div>

            <p class="section-desc">Data source: <span id="bounceDataSource" class="source-aggregate">bounce_events table</span></p>

            <div class="bounce-overview-cards">
                <div class="card">
                    <div class="card-label">Total Bounces</div>
                    <div class="card-value" id="totalBounces">-</div>
                </div>
                <div class="card danger">
                    <div class="card-label">Hard Bounces</div>
                    <div class="card-value" id="hardBounces">-</div>
                </div>
                <div class="card warning">
                    <div class="card-label">Blocks</div>
                    <div class="card-value" id="blockBounces">-</div>
                </div>
                <div class="card">
                    <div class="card-label">Soft Bounces</div>
                    <div class="card-value" id="softBounces">-</div>
                </div>
            </div>

            <div class="bounce-tables-section">
                <div class="table-section">
                    <h3>By Bounce Type</h3>
                    <div class="table-wrapper">
                        <table id="bounceTypeTable">
                            <thead>
                                <tr>
                                    <th>Bounce Type</th>
                                    <th>Count</th>
                                    <th>Percentage</th>
                                </tr>
                            </thead>
                            <tbody id="bounceTypeTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="table-section">
                    <h3>By Infra Type</h3>
                    <div class="table-wrapper">
                        <table id="bounceInfraTable">
                            <thead>
                                <tr>
                                    <th>Infra Type</th>
                                    <th>Count</th>
                                    <th>Percentage</th>
                                </tr>
                            </thead>
                            <tbody id="bounceInfraTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="table-section">
                <h3>By Workspace</h3>
                <div class="table-wrapper">
                    <table id="bounceWorkspaceTable">
                        <thead>
                            <tr>
                                <th>Workspace</th>
                                <th>Bounces</th>
                                <th>Percentage</th>
                            </tr>
                        </thead>
                        <tbody id="bounceWorkspaceTableBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="table-section">
                <h3>Recent Bounce Events</h3>
                <div class="table-wrapper">
                    <table id="bounceEventsTable">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Type</th>
                                <th>Sender Domain</th>
                                <th>Workspace</th>
                                <th>Infra Type</th>
                            </tr>
                        </thead>
                        <tbody id="bounceEventsTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ========================================== -->
        <!-- MAIN TAB: DOMAINS -->
        <!-- ========================================== -->
        <div id="main-tab-domains" class="main-tab-content" style="display: none;">
            <div class="placeholder-message">
                <h2>Domain Health</h2>
                <p>Coming Soon</p>
                <p class="hint">Domain health analysis will be available in a future update.</p>
            </div>
        </div>

        <!-- Meta Info -->
        <footer id="footer">
            <p>Generated: <span id="generatedAt">-</span></p>
        </footer>
    </div>

    <script src="/static/supabase-client.js"></script>
    <script src="/static/app.js"></script>
    <script>
        // Global error handler
        window.onerror = function(msg, url, lineNo, columnNo, error) {
            console.error('Global error:', msg, url, lineNo);
            const loadingEl = document.getElementById('loading');
            if (loadingEl && loadingEl.style.display !== 'none') {
                loadingEl.innerHTML = `
                    <div class="error">
                        <p>An error occurred while loading</p>
                        <p class="hint">${msg}</p>
                        <button class="retry-btn" onclick="location.reload()">Refresh Page</button>
                    </div>
                `;
            }
            return false;
        };

        window.onunhandledrejection = function(event) {
            console.error('Unhandled promise rejection:', event.reason);
        };
    </script>
</body>
</html>
